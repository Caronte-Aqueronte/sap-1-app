<nz-steps nzType="navigation" [nzCurrent]="current">
  <nz-step nzTitle="Identificación"></nz-step>
  <nz-step nzTitle="Promociones"></nz-step>
  <nz-step nzTitle="Resumen"></nz-step>
</nz-steps>

<div class="steps-content mt-4 max-h-[300px] overflow-y-auto pr-2">
  @if (current === 0) {
  <form
    nz-form
    [nzLayout]="'vertical'"
    [formGroup]="searchForm"
    (ngSubmit)="searchClient()"
  >
    <nz-form-item>
      <nz-form-label>Documento de Identidad</nz-form-label>
      <nz-form-control [nzErrorTip]="nationalIdErrorTpl">
        <input
          nz-input
          formControlName="nationalId"
          placeholder="Ingrese DPI/Número de identificación"
        />

        <ng-template #nationalIdErrorTpl let-control>
          @if (control.hasError('required')) {
          <span>El número de identificación es obligatorio</span>
          } @if (control.hasError('minlength') || control.hasError('maxlength'))
          {
          <span
            >El número de identificación debe tener exactamente 13 dígitos</span
          >
          }
        </ng-template>
      </nz-form-control>
    </nz-form-item>
    <button nz-button nzType="primary">Buscar</button>
  </form>

  @if (client) {
  <nz-divider [nzText]="'Cliente seleccionado'"></nz-divider>
  <div class="p-5 rounded-xl bg-white border border-gray-200 shadow-sm">
    <!-- nombre y correo -->
    <div class="flex items-center justify-between mb-2">
      <div class="text-lg font-bold text-[#012e5c]">
        {{ client.firstName }} {{ client.lastName }}
      </div>
      <div class="text-sm text-gray-500">
        {{ client.email }}
      </div>
    </div>

    <nz-divider></nz-divider>

    <!-- datos -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
      <div class="flex items-center gap-2">
        <nz-icon
          nzType="idcard"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span class="font-medium">ID Nacional:</span>
        <span class="text-gray-800">{{ client.nationalId }}</span>
      </div>

      <div class="flex items-center gap-2">
        <nz-icon
          nzType="phone"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span class="font-medium">Tel:</span>
        <span class="text-gray-800">{{ client.phone }}</span>
      </div>

      <div class="flex items-center gap-2 md:col-span-2">
        <nz-icon
          nzType="file-protect"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span class="font-medium">NIT:</span>
        <span class="text-gray-800">{{ client.nit }}</span>
      </div>
    </div>
  </div>

  } @if (clientNotFound) {
  <nz-divider [nzText]="'Informacion del Cliente'"></nz-divider>
  <form nz-form [nzLayout]="'vertical'" [formGroup]="clientForm">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <!-- Nombre -->
      <nz-form-item>
        <nz-form-label>Nombre</nz-form-label>
        <nz-form-control [nzErrorTip]="firstNameErrorTpl">
          <input nz-input formControlName="firstName" />
          <ng-template #firstNameErrorTpl let-control>
            @if (control.hasError('required')) {
            <span>El nombre es obligatorio</span>
            } @if (control.hasError('maxlength')) {
            <span>El nombre no debe exceder 50 caracteres</span>
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- Apellido -->
      <nz-form-item>
        <nz-form-label>Apellido</nz-form-label>
        <nz-form-control [nzErrorTip]="lastNameErrorTpl">
          <input nz-input formControlName="lastName" />
          <ng-template #lastNameErrorTpl let-control>
            @if (control.hasError('required')) {
            <span>El apellido es obligatorio</span>
            } @if (control.hasError('maxlength')) {
            <span>El apellido no debe exceder 50 caracteres</span>
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- Email -->
      <nz-form-item>
        <nz-form-label>Email</nz-form-label>
        <nz-form-control [nzErrorTip]="emailErrorTpl">
          <input nz-input type="email" formControlName="email" />
          <ng-template #emailErrorTpl let-control>
            @if (control.hasError('required')) {
            <span>El correo electrónico es obligatorio</span>
            } @if (control.hasError('email')) {
            <span>El correo electrónico no es válido</span>
            } @if (control.hasError('maxlength')) {
            <span>El correo electrónico no debe exceder 150 caracteres</span>
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- Teléfono -->
      <nz-form-item>
        <nz-form-label>Teléfono</nz-form-label>
        <nz-form-control [nzErrorTip]="phoneErrorTpl">
          <input nz-input formControlName="phone" />
          <ng-template #phoneErrorTpl let-control>
            @if (control.hasError('required')) {
            <span>El número de teléfono es obligatorio</span>
            } @if (control.hasError('maxlength')) {
            <span>El número de teléfono no debe exceder 15 caracteres</span>
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>

      <!-- NIT -->
      <nz-form-item>
        <nz-form-label>NIT</nz-form-label>
        <nz-form-control [nzErrorTip]="nitErrorTpl">
          <input nz-input formControlName="nit" />
          <ng-template #nitErrorTpl let-control>
            @if (control.hasError('required')) {
            <span>El NIT es obligatorio</span>
            } @if (control.hasError('maxlength')) {
            <span>El NIT no debe exceder 15 caracteres</span>
            }
          </ng-template>
        </nz-form-control>
      </nz-form-item>
    </div>

    <!-- Botón -->
    <div class="flex justify-end mt-2">
      <button nz-button nzType="primary" (click)="createClient()">
        Guardar cliente
      </button>
    </div>
  </form>

  } } @if (current === 1) {
  <!--Selección de promociones -->
  <div
    class="p-6 rounded-2xl bg-white border border-gray-200 shadow-md space-y-4"
  >
    <div class="text-2xl font-bold text-[#012e5c] flex items-center gap-2">
      <nz-icon nzType="gift" nzTheme="outline" class="text-[#fb9120]"></nz-icon>
      Selecciona una promoción (opcional)
    </div>

    <nz-radio-group
      [(ngModel)]="selectedPromotionId"
      name="promotionChoice"
      class="flex flex-col gap-3"
    >
      <label nz-radio [nzValue]="''">
        <span class="font-medium">No aplicar promoción</span>
      </label>

      <nz-divider [nzText]="'Promociones de cliente'"></nz-divider>
      @for (promo of clientPromotions; track promo.id) {
      <label nz-radio [nzValue]="promo">
        <span class="font-medium">{{ promo.name }}</span>
        <span class="text-gray-500"> - {{ promo.discountPercent }}%</span>
        <span class="ml-2 text-xs text-gray-400"
          >({{ promo.startDateStr }} - {{ promo.endDateStr }})</span
        >
      </label>
      }

      <nz-divider [nzText]="'Promociones de habitación'"></nz-divider>
      @for (promo of roomPromotions; track promo.id) {
      <label nz-radio [nzValue]="promo">
        <span class="font-medium">{{ promo.name }}</span>
        <span class="text-gray-500"> - {{ promo.discountPercent }}%</span>
        <span class="ml-2 text-xs text-gray-400"
          >({{ promo.startDateStr }} - {{ promo.endDateStr }})</span
        >
      </label>
      }
    </nz-radio-group>
  </div>

  } @if (current === 2) {
  <div
    class="p-6 rounded-2xl bg-white border border-gray-200 shadow-md space-y-4"
  >
    <!-- título -->
    <div class="text-2xl font-bold text-[#012e5c] flex items-center gap-2">
      <nz-icon
        nzType="profile"
        nzTheme="outline"
        class="text-[#fb9120]"
      ></nz-icon>
      Resumen de la reserva
    </div>

    <!-- detalles -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
      <div class="flex items-center gap-2">
        <nz-icon
          nzType="home"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span
          ><span class="font-medium">Habitación:</span>
          {{ data.room.number }}</span
        >
      </div>

      <div class="flex items-center gap-2">
        <nz-icon
          nzType="dollar"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span
          ><span class="font-medium">Precio por noche:</span> Q
          {{ data.room.basePrice }}</span
        >
      </div>

      <div class="flex items-center gap-2">
        <nz-icon
          nzType="login"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span><span class="font-medium">Check-in:</span> {{ checkIn }}</span>
      </div>

      <div class="flex items-center gap-2">
        <nz-icon
          nzType="logout"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span><span class="font-medium">Check-out:</span> {{ checkOut }}</span>
      </div>

      <div class="flex items-center gap-2 md:col-span-2">
        <nz-icon
          nzType="calendar"
          nzTheme="outline"
          class="text-[#fb9120]"
        ></nz-icon>
        <span><span class="font-medium">Noches:</span> {{ nights }}</span>
      </div>
    </div>

    <nz-divider></nz-divider>

    <!-- total -->
    <div
      class="text-[#012e5c] flex flex-col gap-2 items-end"
    >
      @if (selectedPromotionId) {
      <div class="flex items-center justify-between w-full">
        <span>Sub Total</span>
        <span class="line-through text-gray-400">Q {{ total }}</span>
      </div>
      <div class="flex items-center justify-between w-full text-green-600">
        <span>Promoción aplicada:</span>
        <span>-{{ selectedPromotionId.discountPercent }}%</span>
      </div>
      }

      <div class="flex items-center justify-between w-full">
        <span class="text-2xl font-extrabold ">Total a pagar</span>
        <span class="text-2xl font-extrabold text-[#fb9120]">Q {{ discountedTotal }}</span>
      </div>
    </div>
  </div>

  }
</div>

<div *nzModalFooter>
  <div class="steps-action">
    @if (current > 0) {
    <button nz-button nzType="default" (click)="pre()"><span>Ant</span></button>
    } @if (current < 2) {
    <button nz-button nzType="default" (click)="next()">
      <span>Sig</span>
    </button>
    } @if (current === 2) {
    <button nz-button nzType="primary" (click)="confirmBooking()">
      Confirmar
    </button>
    }
  </div>
</div>
